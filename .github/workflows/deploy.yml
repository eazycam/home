name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify secrets are set
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          echo "Checking if secrets are set..."
          [ -z "$FIREBASE_API_KEY" ] && echo "❌ FIREBASE_API_KEY is EMPTY!" || echo "✅ FIREBASE_API_KEY is set (length: ${#FIREBASE_API_KEY})"
          [ -z "$FIREBASE_AUTH_DOMAIN" ] && echo "❌ FIREBASE_AUTH_DOMAIN is EMPTY!" || echo "✅ FIREBASE_AUTH_DOMAIN is set"
          [ -z "$FIREBASE_PROJECT_ID" ] && echo "❌ FIREBASE_PROJECT_ID is EMPTY!" || echo "✅ FIREBASE_PROJECT_ID is set"
          [ -z "$FIREBASE_STORAGE_BUCKET" ] && echo "❌ FIREBASE_STORAGE_BUCKET is EMPTY!" || echo "✅ FIREBASE_STORAGE_BUCKET is set"
          [ -z "$FIREBASE_MESSAGING_SENDER_ID" ] && echo "❌ FIREBASE_MESSAGING_SENDER_ID is EMPTY!" || echo "✅ FIREBASE_MESSAGING_SENDER_ID is set"
          [ -z "$FIREBASE_APP_ID" ] && echo "❌ FIREBASE_APP_ID is EMPTY!" || echo "✅ FIREBASE_APP_ID is set"
          [ -z "$FIREBASE_MEASUREMENT_ID" ] && echo "❌ FIREBASE_MEASUREMENT_ID is EMPTY!" || echo "✅ FIREBASE_MEASUREMENT_ID is set"
          
          # Exit if any secret is missing
          if [ -z "$FIREBASE_API_KEY" ] || [ -z "$FIREBASE_PROJECT_ID" ] || [ -z "$FIREBASE_APP_ID" ]; then
            echo "ERROR: Required secrets are missing! Please add them in GitHub Settings > Secrets"
            exit 1
          fi
      
      - name: Create Firebase Config File
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
        run: |
          cat > firebase-config.js << 'EOF'
          export const firebaseConfig = {
            apiKey: "REPLACE_API_KEY",
            authDomain: "REPLACE_AUTH_DOMAIN",
            projectId: "REPLACE_PROJECT_ID",
            storageBucket: "REPLACE_STORAGE_BUCKET",
            messagingSenderId: "REPLACE_MESSAGING_SENDER_ID",
            appId: "REPLACE_APP_ID",
            measurementId: "REPLACE_MEASUREMENT_ID"
          };
          EOF
          
          # Now replace the placeholders
          sed -i "s|REPLACE_API_KEY|${FIREBASE_API_KEY}|g" firebase-config.js
          sed -i "s|REPLACE_AUTH_DOMAIN|${FIREBASE_AUTH_DOMAIN}|g" firebase-config.js
          sed -i "s|REPLACE_PROJECT_ID|${FIREBASE_PROJECT_ID}|g" firebase-config.js
          sed -i "s|REPLACE_STORAGE_BUCKET|${FIREBASE_STORAGE_BUCKET}|g" firebase-config.js
          sed -i "s|REPLACE_MESSAGING_SENDER_ID|${FIREBASE_MESSAGING_SENDER_ID}|g" firebase-config.js
          sed -i "s|REPLACE_APP_ID|${FIREBASE_APP_ID}|g" firebase-config.js
          sed -i "s|REPLACE_MEASUREMENT_ID|${FIREBASE_MEASUREMENT_ID}|g" firebase-config.js
      
      - name: Show generated file
        run: |
          echo "=== Generated firebase-config.js ==="
          cat firebase-config.js
          echo ""
          echo "=== Checking for placeholders ==="
          if grep -q "REPLACE_" firebase-config.js; then
            echo "❌ ERROR: File still contains placeholders!"
            exit 1
          else
            echo "✅ All placeholders replaced successfully"
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages